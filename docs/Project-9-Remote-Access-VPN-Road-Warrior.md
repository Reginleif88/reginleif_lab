---
title: "Project 9: Remote Access VPN (Road Warrior)"
tags: [vpn, configuration, opnsense, royal-ts]
sites: [hq, wg-peers]
status: completed
---

## Goal

Configure a "Road Warrior" WireGuard peer for the Administrator's PC. This allows secure, direct access to the Royal Server (`P-WIN-SRV1`) and other internal lab resources (`172.16.0.0/24` and `172.17.0.0/24`) without exposing management ports (like 54899) to the main Home Network.

---

## 1. Architecture Design

| Role | Device | Physical IP | Tunnel IP |
| :--- | :--- | :--- | :--- |
| **Server** | OPNsenseHQ | `192.168.1.240` | `10.200.0.1/32` |
| **Client** | Admin PC (Home Network) | *DHCP (Home LAN)* | **`10.200.0.10/32`** |

---

## 2. Configuration: Admin PC (The Client)

**Prerequisite:** Install the official [WireGuard Client](https://www.wireguard.com/install/).

1. Open WireGuard and click **Add Tunnel > Add empty tunnel**.
2. Name it `reginleif-lab`.
3. **Generate Keys:** The client will automatically generate a **Public Key** and **Private Key**.
    * *Copy the Public Key to your clipboard.*
4. **Edit Configuration:**

```ini
[Interface]
PrivateKey = <Auto-Generated-Private-Key>
Address = 10.200.0.10/32
DNS = 172.16.0.10, 172.17.0.10
```

> [!NOTE]
> DNS points to Lab DCs for internal hostname resolution (e.g., p-win-srv1.reginleif.io)
>
> **Expected Behavior:** When the VPN tunnel is inactive, DNS queries to lab DCs will timeout before Windows falls back to your home network's DNS servers. This may cause brief delays (several seconds) when starting web browsers or other network applications. This is normal for split-tunnel VPN configurations and resolves once the tunnel is activated.

```ini
[Peer]
# OPNsenseHQ
PublicKey = <Paste-OPNsenseHQ-Public-Key-Here>
AllowedIPs = 172.16.0.0/24, 172.17.0.0/24, 10.200.0.0/24
Endpoint = 192.168.1.240:51820
PersistentKeepalive = 25
```

---

## 3. Configuration: OPNsenseHQ (The Server)

Add the Admin PC as a known peer to the existing `HQ_Instance` (created in Project 7).

1. **Navigate to:** VPN > WireGuard > **Peers**.
2. **Add New Peer:**
    * **Name:** `Admin-PC`
    * **Public Key:** (Paste the Public Key from Step 2)
    * **Allowed IPs:** `10.200.0.10/32`
    * *(Note: This restricts the tunnel so this peer can ONLY spoof this specific IP).*
    * In the **Instances** dropdown, select `HQ_Instance`.
3. **Save & Apply**.

---

## 4. Firewall Rules (OPNsenseHQ)

The `Trusted_Lab_Networks` alias created in Project 7 already includes the WireGuard tunnel subnet (`10.200.0.0/24`). This means road warrior traffic is automatically permitted by the existing rule:

```md
Source: Trusted_Lab_Networks â†’ Destination: Trusted_Lab_Networks
```

**No additional firewall rules are required.** The road warrior client (`10.200.0.10`) can:

* Access HQ LAN resources (`172.16.0.0/24`)
* Access Branch LAN resources (`172.17.0.0/24`) via the site-to-site tunnel
* Query DNS on Domain Controllers (`172.16.0.10`, `172.17.0.10`)

> **Strict Option:** If you want to limit the Admin PC to specific resources only, create a dedicated rule:
>
> * **Action:** Pass
> * **Source:** `10.200.0.10/32`
> * **Destination:** `172.16.0.11/32` (Royal Server only)
> * **Port:** 54899

---

## 5. Windows Host Firewall (P-WIN-SRV1)

> [!IMPORTANT]
> OPNsense firewall rules permit traffic at the network level, but Windows Server has its own host-based firewall. If the "Allow Lab Subnets" rules from Project 8 were not applied to P-WIN-SRV1, connections from the VPN will be blocked.

**On P-WIN-SRV1:**

```powershell
# [P-WIN-SRV1]
# Allow all TCP traffic from lab subnets
New-NetFirewallRule -DisplayName "Allow Lab Subnets - TCP" -Direction Inbound `
    -LocalPort Any -Protocol TCP -Action Allow `
    -RemoteAddress 172.16.0.0/24,172.17.0.0/24,10.200.0.0/24

# Allow all UDP traffic from lab subnets
New-NetFirewallRule -DisplayName "Allow Lab Subnets - UDP" -Direction Inbound `
    -LocalPort Any -Protocol UDP -Action Allow `
    -RemoteAddress 172.16.0.0/24,172.17.0.0/24,10.200.0.0/24
```

**Verify connectivity from your VPN client:**

```powershell
Test-NetConnection -ComputerName 172.16.0.11 -Port 54899
```

---

## 6. Royal TS Configuration (Final Link)

Now that the tunnel provides a route, configure Royal TS on the Admin PC.

1. **Activate VPN:** Click **Activate** in the WireGuard client.
2. **Open Royal TS.**
3. **Royal Server Object:**
    * **Computer Name:** `172.16.0.11` (or `p-win-srv1.reginleif.io` if DNS is working).
    * **Port:** `54899` (Default).
4. **Test Connection:**
    * Right-click > **Test**.
    * *Expected Result:* **Green / Success**.
5. **Use as Gateway:**
    * You can now set this Royal Server object as the **Secure Gateway** for all other connections (RDP to DCs, SSH to OPNsense), keeping them completely isolated from the Home Network.

---

## 7. Validation Checklist

* [ ] **VPN Connection:** WireGuard client shows "Active" and "Data Received" increments.
* [ ] **Ping:** Can ping `172.16.0.1` (Gateway) and `172.16.0.11` (Royal Server).
* [ ] **DNS:** `nslookup p-win-srv1.reginleif.io` resolves to `172.16.0.11`.
* [ ] **Royal Server:** Royal TS successfully connects to the management service.
